<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AWS ë³´ì•ˆ ê´€ì œ ì„¼í„°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-dark: #0f1115;
      --bg-card: #161b22;
      --border: #30363d;
      --text-main: #c9d1d9;
      --accent: #58a6ff;
    }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      overflow-x: hidden;
    }
    body, .overflow-auto, .overflow-y-scroll, .overflow-x-auto {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    body::-webkit-scrollbar,
    .overflow-auto::-webkit-scrollbar {
      display: none;
    }
    @keyframes flash-critical {
      0% { background-color: rgba(218, 54, 51, 0.4); }
      100% { background-color: transparent; }
    }
    .animate-flash { animation: flash-critical 2s ease-out; }

    .card {
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }
    th.sortable { cursor: pointer; user-select: none; transition: background-color 0.2s; }
    th.sortable:hover { background-color: #21262d; }
    th.sortable::after { content: ' â†•'; font-size: 10px; opacity: 0.3; float: right; margin-left: 4px; }
    th.sortable.asc::after { content: ' â–²'; opacity: 1; color: var(--accent); }
    th.sortable.desc::after { content: ' â–¼'; opacity: 1; color: var(--accent); }

    thead th {
      position: sticky;
      top: 0;
      background-color: var(--bg-card);
      z-index: 10;
      box-shadow: 0 1px 0 var(--border);
    }
    tr:hover { background-color: rgba(255,255,255,0.03); cursor: pointer; }

    .collapsible {
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
    }
    .collapsible.open {
      max-height: 300px;
      opacity: 1;
    }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2; 
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal; 
      word-break: break-all; 
    }
  </style>
</head>

<body class="text-sm">
  <header class="sticky top-0 z-50 border-b border-[#30363d] bg-[#0f1115]/95 backdrop-blur-md">
    <div class="max-w-[1500px] w-full px-2 md:px-3 mx-auto py-3 md:h-16 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">

      <div class="bg-[#0d1117] p-4 border-b border-[#30363d] rounded-md md:border-none md:bg-transparent md:p-0">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 flex items-center justify-center text-blue-500 shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full drop-shadow-[0_0_8px_rgba(59,130,246,0.5)]">
              <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
              <path d="M12 3v2"/>
              <path d="M12 19v2"/>
              <circle cx="12" cy="12" r="3"/>
              <path d="M3.5 10.5 5 12l-1.5 1.5"/>
              <path d="M20.5 10.5 19 12l1.5 1.5"/>
            </svg>
          </div>
          <h1 class="text-lg font-bold tracking-tight text-white whitespace-nowrap">
            AWS ë³´ì•ˆ ê´€ì œ ì„¼í„°
          </h1>
        </div>
      </div>

      <div class="flex items-center justify-end gap-3">
        <span id="connectionStatus"
              class="px-3 py-1 rounded-full text-xs font-medium bg-gray-800 text-gray-400 border border-gray-700 flex items-center gap-1.5 whitespace-nowrap">
          <span class="w-2 h-2 rounded-full bg-gray-500"></span> ì—°ê²° ëŒ€ê¸°
        </span>

        <button id="toggleMock"
                class="px-3 py-1.5 text-xs font-medium bg-gray-800 border border-gray-700 rounded hover:bg-gray-700 transition-colors text-gray-300 whitespace-nowrap">
          Mock ë°ì´í„°: OFF
        </button>

        <button onclick="toggleSettings()"
                class="p-2 rounded-md hover:bg-gray-800 text-gray-400 hover:text-white transition-colors border border-transparent hover:border-gray-700"
                title="ì—°ê²° ì„¤ì • ì—´ê¸°">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
               viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
        </button>
      </div>
    </div>

    <div id="settingsPanel" class="collapsible border-b border-[#30363d] bg-[#0d1117]">
      <div class="max-w-[1500px] w-full px-2 md:px-3 mx-auto py-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-xs text-gray-500 mb-1 font-medium">ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ URL (ë³´ì•ˆ ì´ë²¤íŠ¸)</label>
          <input id="eventUrl" type="text" class="w-full bg-[#010409] border border-[#30363d] rounded px-3 py-2 text-xs focus:border-blue-500 outline-none text-gray-300 transition-colors placeholder-gray-700" placeholder="wss://...">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1 font-medium">ëŒ€ì‘ ìŠ¤íŠ¸ë¦¼ URL (ìë™ ì¡°ì¹˜)</label>
          <input id="remedUrl" type="text" class="w-full bg-[#010409] border border-[#30363d] rounded px-3 py-2 text-xs focus:border-blue-500 outline-none text-gray-300 transition-colors placeholder-gray-700" placeholder="wss://...">
        </div>
        <div class="flex gap-3 items-end">
          <div class="flex-1">
            <label class="block text-xs text-gray-500 mb-1 font-medium">íˆìŠ¤í† ë¦¬ URL (ì´ë ¥ ê´€ë¦¬)</label>
            <input id="historyUrl" type="text" class="w-full bg-[#010409] border border-[#30363d] rounded px-3 py-2 text-xs focus:border-blue-500 outline-none text-gray-300 transition-colors placeholder-gray-700" placeholder="wss://...">
          </div>
          <button id="saveUrls" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded text-xs font-bold h-[34px] transition-colors shadow-lg shadow-blue-900/20 whitespace-nowrap">
            ì €ì¥ ë° ì—°ê²°
          </button>
        </div>
      </div>
    </div>
  </header>
  <main class="max-w-[1500px] w-full px-2 md:px-3 mx-auto py-6 space-y-6">

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card p-5 border-l-4 border-l-blue-500 relative overflow-hidden group hover:border-blue-400 transition-colors">
        <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1 truncate">ê¸ˆì¼ ì´ ì¸ì‹œë˜íŠ¸</div>
        <div class="flex items-baseline gap-2 z-10">
          <span id="kpiTotal" class="text-3xl font-bold text-white">0</span>
          <span class="text-xs text-gray-500 whitespace-nowrap">ê±´ ë°œìƒ</span>
        </div>
      </div>

      <div class="card p-5 border-l-4 border-l-red-500 relative overflow-hidden group hover:border-red-400 transition-colors">
        <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1 truncate">ì‹¬ê°í•¨ (Critical)</div>
        <div class="flex items-baseline gap-2 z-10">
          <span id="kpiCritical" class="text-3xl font-bold text-white">0</span>
          <span class="text-xs text-red-400 font-bold animate-pulse whitespace-nowrap" id="criticalIndicator" style="display:none">â— ì¡°ì¹˜ í•„ìš”</span>
        </div>
      </div>

      <div class="card p-5 border-l-4 border-l-green-500 relative overflow-hidden group hover:border-green-400 transition-colors">
        <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1 truncate">ìë™ ëŒ€ì‘ ì„±ê³µ</div>
        <div class="flex items-baseline gap-2 z-10">
          <span id="kpiRemed" class="text-3xl font-bold text-white">0</span>
          <span class="text-xs text-green-500 font-medium whitespace-nowrap">ë°©ì–´ ì„±ê³µ</span>
        </div>
      </div>

      <div class="card p-5 border-l-4 border-l-gray-500 relative overflow-hidden">
        <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1 truncate">ì‹œìŠ¤í…œ ìƒíƒœ</div>
        <div class="flex items-baseline gap-2 z-10">
          <span class="text-xl md:text-2xl font-bold text-green-400 truncate">ì •ìƒ ê°€ë™</span>
        </div>
        <div class="text-xs text-gray-600 mt-1 truncate">ëª¨ë“  ê°ì§€/ëŒ€ì‘ í™œì„±</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-auto md:h-[340px]">
      <div class="card lg:col-span-2 p-5 h-[300px] md:h-full">
        <h2 class="font-bold text-gray-200 mb-4 text-sm flex items-center gap-2">
          ì‹œê°„ëŒ€ë³„ ë°œìƒ ì¶”ì´ (ìµœê·¼ 24ì‹œê°„)
        </h2>
        <div class="flex-1 relative w-full h-full min-h-0">
          <canvas id="trendChart"></canvas>
        </div>
      </div>

      <div class="card p-5 h-[300px] md:h-full">
        <h2 class="font-bold text-gray-200 mb-4 text-sm">ìœ„í—˜ë„ë³„ ë¶„í¬</h2>
        <div class="flex-1 relative w-full h-full min-h-0 flex justify-center">
          <canvas id="severityChart"></canvas>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
      <div class="card flex flex-col">
        <div class="px-5 py-3 border-b border-[#30363d] bg-[#161b22] flex justify-between items-center sticky top-0 z-20">
          <h2 class="font-bold text-gray-200 text-sm flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
            ì‹¤ì‹œê°„ ë³´ì•ˆ ì´ë²¤íŠ¸
            <span id="status-events"
                  class="ml-2 px-2 py-0.5 rounded text-[10px] border border-gray-700 bg-gray-800 text-gray-500 font-normal transition-colors">
              â— ë¯¸ì—°ê²°
            </span>
          </h2>

          <span id="eventsCountBadge"
                class="bg-gray-800 text-gray-400 px-2 py-0.5 rounded text-xs font-mono">0</span>
        </div>

        <div class="overflow-auto bg-[#0d1117] flex-1 min-h-[150px] max-h-[400px]">
          <table class="w-full min-w-[700px] text-left border-collapse table-fixed">
            <thead class="text-gray-400 text-xs uppercase bg-[#0d1117] sticky top-0 z-10 shadow-sm">
              <tr>
                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-24 sortable whitespace-nowrap text-center"
                    data-table="events" data-key="time">ì‹œê°„</th>

                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-24 sortable whitespace-nowrap text-center"
                    data-table="events" data-key="source">ì†ŒìŠ¤</th>

                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-30 sortable whitespace-nowrap text-center"
                    data-table="events" data-key="type">ì´ë²¤íŠ¸ ìœ í˜•</th>

                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-38 sortable whitespace-nowrap text-center"
                    data-table="events" data-key="arn">ARN</th>

                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-24 sortable whitespace-nowrap text-center"
                    data-table="events" data-key="severity">ì‹¬ê°ë„</th>
              </tr>
            </thead>
            <tbody id="eventsBody"
                   class="text-gray-300 text-xs divide-y divide-[#30363d]">
            </tbody>
          </table>
        </div>
      </div>

      <div class="card flex flex-col">
        <div class="px-5 py-3 border-b border-[#30363d] bg-[#161b22] flex justify-between items-center sticky top-0 z-20">
          <h2 class="font-bold text-gray-200 text-sm flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
            ìë™ ëŒ€ì‘ ë¡œê·¸
            <span id="status-remed"
                  class="ml-2 px-2 py-0.5 rounded text-[10px] border border-gray-700 bg-gray-800 text-gray-500 font-normal transition-colors">
              â— ë¯¸ì—°ê²°
            </span>
          </h2>

          <span id="remedsCountBadge"
                class="bg-gray-800 text-gray-400 px-2 py-0.5 rounded text-xs font-mono">0</span>
        </div>

        <div class="overflow-auto bg-[#0d1117] flex-1 min-h-[150px] max-h-[400px]">
          <table class="w-full min-w-[600px] text-left border-collapse table-fixed">
            <thead class="text-gray-400 text-xs uppercase bg-[#0d1117] sticky top-0 z-10 shadow-sm">
              <tr>
                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-24 sortable whitespace-nowrap text-center"
                    data-table="remeds" data-key="time">ì‹œê°„</th>

                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-32 sortable whitespace-nowrap text-center"
                    data-table="remeds" data-key="action">ì¡°ì¹˜ ë‚´ìš©</th>

                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-28 sortable whitespace-nowrap text-center"
                    data-table="remeds" data-key="target">ëŒ€ìƒ</th>

                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-24 sortable whitespace-nowrap text-center"
                    data-table="remeds" data-key="status">ìƒíƒœ</th>
              </tr>
            </thead>

            <tbody id="remedsBody"
                   class="text-gray-300 text-xs divide-y divide-[#30363d]">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card flex flex-col h-[500px]">
      <div class="px-5 py-3 border-b border-[#30363d] bg-[#161b22] flex flex-col md:flex-row md:justify-between md:items-center gap-3 sticky top-0 z-20">
        <h2 class="font-bold text-gray-200 text-sm flex items-center">
          ì¸ì‹œë˜íŠ¸ ì´ë ¥ ê´€ë¦¬ (History)
          <span id="status-history"
                class="ml-2 px-2 py-0.5 rounded text-[10px] border border-gray-700 bg-gray-800 text-gray-500 font-normal transition-colors">
            â— ë¯¸ì—°ê²°
          </span>
        </h2>

        <div class="flex flex-wrap gap-2 w-full md:w-auto">
          <input id="historySearch"
                 type="text"
                 placeholder="ID, ìœ í˜•, ë¦¬ì†ŒìŠ¤ ê²€ìƒ‰..."
                 class="bg-[#0d1117] border border-[#30363d] rounded px-3 py-1.5 text-xs text-gray-300 w-full md:w-64 focus:border-blue-500 outline-none placeholder-gray-600 transition-colors">

          <div class="flex gap-2 w-full md:w-auto">
            <select id="historySeverityFilter"
                    class="bg-[#0d1117] border border-[#30363d] rounded px-3 py-1.5 text-xs text-gray-300 focus:border-blue-500 outline-none transition-colors flex-1 md:flex-none">
              <option value="ALL">ëª¨ë“  ì‹¬ê°ë„</option>
              <option value="CRITICAL">Critical</option>
              <option value="HIGH">High</option>
              <option value="MEDIUM">Medium</option>
              <option value="LOW">Low</option>
            </select>

            <select id="historyStatusFilter"
                    class="bg-[#0d1117] border border-[#30363d] rounded px-3 py-1.5 text-xs text-gray-300 focus:border-blue-500 outline-none transition-colors flex-1 md:flex-none">
              <option value="ALL">ëª¨ë“  ìƒíƒœ</option>
              <option value="NEW">ì‹ ê·œ</option>
              <option value="PROCESSING">ì§„í–‰ì¤‘</option>
              <option value="MITIGATED">ì™„í™”ë¨</option>
              <option value="CLOSED">ì¢…ë£Œ</option>
            </select>
          </div>
        </div>
      </div>

      <div class="overflow-auto bg-[#0d1117] flex-1">
        <table class="w-full min-w-[1200px] text-left border-collapse table-fixed">
          <thead class="text-gray-400 text-xs uppercase bg-[#161b22] sticky top-0 z-10 shadow-sm border-b border-[#30363d]">
            <tr>
              <th class="px-4 py-3 font-semibold w-28 sortable whitespace-nowrap text-center"
                  data-table="incidents" data-key="incident_id">ì¸ì‹œë˜íŠ¸ ID</th>

              <th class="px-4 py-3 font-semibold w-40 sortable whitespace-nowrap text-center"
                  data-table="incidents" data-key="event_type">ì´ë²¤íŠ¸ ìœ í˜•</th>

              <th class="px-4 py-3 font-semibold w-60 sortable whitespace-nowrap text-center"
                  data-table="incidents" data-key="resource">ë¦¬ì†ŒìŠ¤</th>

              <th class="px-4 py-3 font-semibold w-24 sortable whitespace-nowrap text-center"
                  data-table="incidents" data-key="severity">ì‹¬ê°ë„</th>

              <th class="px-4 py-3 font-semibold w-32 sortable whitespace-nowrap text-center"
                  data-table="incidents" data-key="status">ìƒíƒœ</th>

              <th class="px-4 py-3 font-semibold w-24 sortable whitespace-nowrap text-center"
                  data-table="incidents" data-key="notify_status">ì•Œë¦¼ ìƒíƒœ</th>

              <th class="px-4 py-3 font-semibold w-24 whitespace-nowrap text-center">ë©”ëª¨</th>

              <th class="px-4 py-3 font-semibold w-24 sortable whitespace-nowrap text-center"
                  data-table="incidents" data-key="created_at">ë°œìƒ ì‹œê°„</th>

              <th class="px-4 py-3 font-semibold w-24 sortable whitespace-nowrap text-center"
                  data-table="incidents" data-key="updated_at">ì¡°ì¹˜ ì‹œê°„</th>
            </tr>
          </thead>

          <tbody id="incidentBody"
                 class="text-gray-300 text-xs divide-y divide-[#30363d]">
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="detailModal"
       class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-[100] px-2">
    <div class="bg-[#161b22] border border-[#30363d] rounded-lg shadow-2xl w-full max-w-3xl max-h-[85vh] flex flex-col animate-[fadeIn_0.2s_ease-out]">
      <div class="px-6 py-4 border-b border-[#30363d] flex justify-between items-center bg-[#161b22] rounded-t-lg">
        <h3 class="font-bold text-white text-lg flex items-center gap-2">
          ğŸ” ìƒì„¸ ì •ë³´ ë° ì¡°ì¹˜
        </h3>
        <button onclick="closeModal()"
                class="text-gray-400 hover:text-white text-2xl leading-none transition-colors">&times;</button>
      </div>

      <div id="detailContent"
           class="p-6 overflow-y-auto text-sm text-gray-300 space-y-6"></div>
    </div>
  </div>

  <script>
    /* ê¸°ë³¸ UI í† ê¸€ */
    function toggleSettings() {
      document.getElementById('settingsPanel').classList.toggle('open');
    }

    function closeModal() {
      const modal = document.getElementById('detailModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    /* ìƒíƒœ / ë°ì´í„° ì €ì¥ì†Œ */
    const INCIDENT_UPDATE_ENDPOINT =
      "https://uagp4c6jbh.execute-api.us-east-1.amazonaws.com/incident/update";

    const CLIENT_AUTH = {
      clientId: "dashboard_admin",
      account: "021417007719",
      region: "us-east-1"
    };

    const state = {
      events: [],
      remeds: [],
      incidents: [],
      mockOn: false,
      timers: { mock: null },
      ws: { events: null, remeds: null, history: null },
      buckets: new Map(),
      sort: {
        events: { key: 'time', dir: 'desc' },
        remeds: { key: 'time', dir: 'desc' },
        incidents: { key: 'created_at', dir: 'desc' }
      }
    };

    let currentIncidentId = null;

    /* Chart.js ê¸°ë³¸ ì„¤ì • */
    Chart.defaults.color = '#8b949e';
    Chart.defaults.borderColor = '#30363d';
    Chart.defaults.font.family = "'Noto Sans KR', sans-serif";

    const trendChart = new Chart(document.getElementById('trendChart'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'ì´ë²¤íŠ¸ ë°œìƒ',
          data: [],
          borderColor: '#58a6ff',
          backgroundColor: 'rgba(88, 166, 255, 0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true,
          pointRadius: 2,
          pointHoverRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
        scales: {
          x: { grid: { display: false }, ticks: { maxTicksLimit: 12, font: { size: 11 } } },
          y: { beginAtZero: true, grid: { color: '#21262d' }, ticks: { stepSize: 1, font: { size: 11 } } }
        },
        interaction: { intersect: false, mode: 'index' }
      }
    });

    const severityChart = new Chart(document.getElementById('severityChart'), {
      type: 'doughnut',
      data: {
        labels: ['Critical', 'High', 'Medium', 'Low'],
        datasets: [{
          data: [0, 0, 0, 0],
          backgroundColor: ['#da3633', '#d29922', '#db6d28', '#238636'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 12,
              font: { size: 11 },
              color: '#c9d1d9'
            }
          }
        }
      }
    });
    /* ì •ë ¬ ê¸°ëŠ¥ */
    function handleSort(tableType, key) {
      const current = state.sort[tableType];
      if (current.key === key) {
        current.dir = current.dir === 'asc' ? 'desc' : 'asc';
      } else {
        current.key = key;
        current.dir = 'desc';
      }

      document.querySelectorAll(`th[data-table="${tableType}"]`).forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.key === key) th.classList.add(current.dir);
      });

      renderTables();
    }

    function getSortedData(data, config) {
      const { key, dir } = config;
      const modifier = dir === 'asc' ? 1 : -1;
      const severityOrder = { CRITICAL: 4, HIGH: 3, MEDIUM: 2, LOW: 1 };

      return [...data].sort((a, b) => {
        let vA = a[key] ?? '';
        let vB = b[key] ?? '';

        if (typeof vA === 'number' && typeof vB === 'number')
          return (vA - vB) * modifier;

        if (key === 'severity')
          return ((severityOrder[vA] || 0) - (severityOrder[vB] || 0)) * modifier;

        return String(vA).localeCompare(String(vB)) * modifier;
      });
    }

    /* KPI / ì°¨íŠ¸ ì—…ë°ì´íŠ¸ */
    function updateCharts() {
      const now = Date.now();
      const labels = [], data = [];

      for (let i = 23; i >= 0; i--) {
        const t = new Date(now - i * 60 * 60 * 1000);
        t.setMinutes(0, 0, 0);
        const key = t.getTime();
        labels.push(`${t.getHours().toString().padStart(2, '0')}:00`);
        data.push(state.buckets.get(key) || 0);
      }

      trendChart.data.labels = labels;
      trendChart.data.datasets[0].data = data;
      trendChart.update('none');

      const sevCounts = { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 0 };
      state.incidents.forEach(i => {
        const s = (i.severity || 'LOW').toUpperCase();
        if (sevCounts[s] !== undefined) sevCounts[s]++;
      });

      severityChart.data.datasets[0].data = [
        sevCounts.CRITICAL,
        sevCounts.HIGH,
        sevCounts.MEDIUM,
        sevCounts.LOW
      ];
      severityChart.update();

      document.getElementById('kpiTotal').textContent = state.incidents.length;
      document.getElementById('kpiCritical').textContent = sevCounts.CRITICAL;
      document.getElementById('kpiRemed').textContent =
        state.remeds.filter(r => r.status === 'SUCCEEDED').length;

      const critInd = document.getElementById('criticalIndicator');
      critInd.style.display = sevCounts.CRITICAL > 0 ? 'inline' : 'none';
    }

    /* ì‹¤ì‹œê°„ ë²„í‚· ì¹´ìš´íŠ¸ */
    function addEventBucket(ts) {
      const d = new Date(ts);
      d.setMinutes(0,0,0);
      const key = d.getTime();
      state.buckets.set(key, (state.buckets.get(key) || 0) + 1);
    }

    /* í…Œì´ë¸” ë Œë”ë§ */
    function renderTables() {
      /** 1) ë³´ì•ˆ ì´ë²¤íŠ¸ í…Œì´ë¸” **/
      const sortedEvents = getSortedData(state.events, state.sort.events);
      const evBody = document.getElementById('eventsBody');

      evBody.innerHTML = sortedEvents.slice(0, 20).map(e => `
        <tr onclick="showDetail(state.events[${state.events.indexOf(e)}], 'event')"
            class="transition-colors border-b border-[#30363d]/50 hover:bg-[#161b22]
            ${e.severity === 'CRITICAL' ? 'animate-flash' : ''}">
          <td class="px-4 py-3 text-gray-400 font-mono text-xs text-center align-middle">
            ${formatTime(e.time)}
          </td>

          <td class="px-4 py-3 text-gray-300 text-center align-middle" title="${e.source || '-'}">
            ${e.source || '-'}
          </td>

          <td class="px-4 py-3 text-gray-200 font-medium text-center align-middle">
            <div class="line-clamp-2 max-w-[120px] mx-auto" title="${e.type}">
              ${e.type}
            </div>
          </td>

          <td class="px-4 py-3 text-gray-400 text-center align-middle">
            <div class="line-clamp-2 max-w-[150px] mx-auto" title="${e.arn || e.resource}">
              ${e.arn || e.resource || '-'}
            </div>
          </td>

          <td class="px-4 py-3 text-center align-middle">
            <span class="inline-block px-2 py-0.5 rounded text-[11px] font-bold ${getBadgeClass(e.severity)}">
              ${e.severity}
            </span>
          </td>
        </tr>
      `).join('');
      document.getElementById('eventsCountBadge').textContent = state.events.length;

      /** 2) ìë™ ëŒ€ì‘ ë¡œê·¸ **/
      const sortedRemeds = getSortedData(state.remeds, state.sort.remeds);
      const remBody = document.getElementById('remedsBody');

      remBody.innerHTML = sortedRemeds.slice(0, 20).map(r => `
        <tr onclick="showDetail(state.remeds[${state.remeds.indexOf(r)}], 'remed')"
            class="border-b border-[#30363d]/50 hover:bg-[#161b22]">
          <td class="px-4 py-3 text-gray-400 font-mono text-xs text-center align-middle">
            ${formatTime(r.time)}
          </td>

          <td class="px-4 py-3 text-blue-400 font-medium text-center align-middle">
            <div class="line-clamp-2 mx-auto">${r.action}</div>
          </td>
          
          <td class="px-4 py-3 text-gray-400 text-center align-middle">
            <div class="line-clamp-2 mx-auto">${r.target}</div>
          </td>

          <td class="px-4 py-3 text-center align-middle">
            <span class="inline-block px-2 py-0.5 rounded text-[11px] font-bold ${getRemedClass(r.status)}">
              ${r.status}
            </span>
          </td>
        </tr>
      `).join('');
      document.getElementById('remedsCountBadge').textContent = state.remeds.length;

      /** 3) ì¸ì‹œë˜íŠ¸ íˆìŠ¤í† ë¦¬ **/
      const search = document.getElementById('historySearch').value.toLowerCase();
      const filterSev = document.getElementById('historySeverityFilter').value;
      const filterStatus = document.getElementById('historyStatusFilter').value;

      let filtered = state.incidents.filter(i => {
        if (filterSev !== 'ALL' && i.severity !== filterSev) return false;
        if (filterStatus !== 'ALL' && i.status !== filterStatus) return false;
        if (search && !JSON.stringify(i).toLowerCase().includes(search)) return false;
        return true;
      });

      filtered = getSortedData(filtered, state.sort.incidents);

      document.getElementById('incidentBody').innerHTML = filtered.slice(0, 50).map(i => {
        const statusColorClass =
          i.status === 'NEW' ? 'text-blue-400' :
          i.status === 'MITIGATED' ? 'text-green-400' :
          i.status === 'CLOSED' ? 'text-gray-500' :
          'text-yellow-400';

        const notifyStatus = i.notify_status || 'SENT';

        return `
        <tr onclick="showDetail(state.incidents.find(x => x.incident_id == '${i.incident_id}'), 'incident')"
            class="border-b border-[#30363d]/50 hover:bg-[#161b22]">
          <td class="px-4 py-3 font-mono text-blue-400 text-xs text-center align-middle"
              title="${i.incident_id}">${i.incident_id}</td>

          <td class="px-4 py-3 text-gray-200 font-medium text-center align-middle"
              title="${i.event_type}">
              <div class="line-clamp-2 mx-auto">${i.event_type}</div>
          </td>

          <td class="px-4 py-3 text-gray-400 text-center align-middle">
             <div class="line-clamp-2 max-w-[200px] mx-auto" title="${i.resource}">
                ${i.resource}
             </div>
          </td>

          <td class="px-4 py-3 text-center align-middle">
            <span class="inline-block px-2 py-0.5 rounded text-[11px] font-bold ${getBadgeClass(i.severity)}">
              ${i.severity}
            </span>
          </td>

          <td class="px-4 py-3 text-center align-middle">
            <select onchange="updateIncidentStatus('${i.incident_id}', this.value)"
                    class="w-full bg-transparent border border-gray-700 rounded px-1 py-1 text-xs font-bold
                    ${statusColorClass}">
              <option value="NEW"        ${i.status === 'NEW' ? 'selected' : ''}>NEW</option>
              <option value="PROCESSING" ${i.status === 'PROCESSING' ? 'selected' : ''}>PROCESSING</option>
              <option value="MITIGATED"  ${i.status === 'MITIGATED' ? 'selected' : ''}>MITIGATED</option>
              <option value="CLOSED"     ${i.status === 'CLOSED' ? 'selected' : ''}>CLOSED</option>
            </select>
          </td>

          <td class="px-4 py-3 text-center align-middle">
            <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold tracking-wider
                  ${getNotifyBadgeClass(notifyStatus)}">
              ${notifyStatus.toUpperCase()}
            </span>
          </td>

          <td class="px-4 py-3 text-gray-500 text-xs text-center align-middle"
              title="${i.note || ''}">
             <div class="line-clamp-2 max-w-[100px] mx-auto">${i.note || '-'}</div>
          </td>

          <td class="px-4 py-3 text-gray-500 font-mono text-xs text-center align-middle">
            ${formatTime(i.created_at)}
          </td>

          <td class="px-4 py-3 text-gray-500 font-mono text-xs text-center align-middle">
            ${formatTime(i.updated_at)}
          </td>
        </tr>`;
      }).join('');
    }
    /* ì¸ì‹œë˜íŠ¸ ìƒíƒœ ë³€ê²½ */
    async function updateIncidentStatus(id, newStatus) {
      const inc = state.incidents.find(i => i.incident_id === id);
      if (inc) {
        inc.status = newStatus;
        inc.updated_at = Date.now();
      }

      renderTables();

      try {
        await fetch(INCIDENT_UPDATE_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ incident_id: id, status: newStatus })
        });
      } catch (e) { console.error("updateIncidentStatus error:", e); }
    }

    /* Remediation ë¡œê·¸ ìˆ˜ì‹  ì²˜ë¦¬ */
    function addRemedSafe(r) {
      if (!r.action || String(r.action).toLowerCase() === 'ping') return;
      if (String(r.action).toLowerCase() === 'pong') return;

      state.remeds.push({ ...r, time: Date.now() });

      if (r.incident_id && r.status === 'SUCCEEDED') {
        const inc = state.incidents.find(i => i.incident_id === r.incident_id);
        if (inc) {
          inc.status = 'MITIGATED';
          inc.updated_at = Date.now();
        }
      }

      updateCharts();
      renderTables();
    }

    /* ìƒì„¸ ì •ë³´ ëª¨ë‹¬ */
    function showDetail(data, type) {
      if (!data) return;

      currentIncidentId = data.incident_id || null;

      const modal = document.getElementById('detailModal');
      const content = document.getElementById('detailContent');

      let html = `<div class="grid grid-cols-[120px_1fr] gap-y-4 text-sm">`;

      const labelMap = {
        time: 'ì‹œê°„',
        source: 'ì†ŒìŠ¤',
        type: 'ìœ í˜•',
        sg: 'ë³´ì•ˆê·¸ë£¹',
        arn: 'ARN',
        resource: 'ë¦¬ì†ŒìŠ¤',
        account: 'ê³„ì •ID',
        region: 'ë¦¬ì „',
        severity: 'ì‹¬ê°ë„',
        ip: 'IP ì£¼ì†Œ',
        action: 'ì¡°ì¹˜ëª…',
        target: 'ëŒ€ìƒ',
        playbook: 'í”Œë ˆì´ë¶',
        status: 'ìƒíƒœ',
        incident_id: 'ì¸ì‹œë˜íŠ¸ ID',
        event_type: 'ì´ë²¤íŠ¸ ìœ í˜•',
        created_at: 'ìƒì„±ì¼',
        updated_at: 'ìˆ˜ì •ì¼',
        note: 'ê´€ë¦¬ì ë©”ëª¨'
      };

      Object.keys(data).forEach(k => {
        if (['meta', 'details', 'related'].includes(k)) return;

        let val = data[k];
        if (val === undefined || val === null) return;

        let display = val;

        if (['time', 'created_at', 'updated_at'].includes(k))
          display = formatTime(val);

        if (k === 'severity')
          display = `<span class="${getBadgeClass(val)} px-2 py-0.5 rounded text-xs">${val}</span>`;

        if (k === 'status') {
          const c =
            val === 'NEW' ? 'text-blue-400' :
            val === 'MITIGATED' ? 'text-green-400' :
            val === 'CLOSED' ? 'text-gray-500' :
            'text-yellow-400';
          display = `<span class="${c} font-bold">${val}</span>`;
        }

        html += `
          <div class="font-semibold text-gray-500">${labelMap[k] || k}</div>
          <div class="text-gray-200 break-all">${display}</div>
        `;
      });

      html += `</div>`;

      /* ì¸ì‹œë˜íŠ¸ ê´€ë¦¬ ì˜ì—­ */
      if (type === 'incident' || data.incident_id) {
        html += `
          <div class="mt-6 pt-6 border-t border-[#30363d]">
            <h4 class="text-base font-bold text-white mb-4">ğŸ› ï¸ ì¸ì‹œë˜íŠ¸ ê´€ë¦¬</h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs text-gray-500 mb-1">ì§„í–‰ ìƒíƒœ ë³€ê²½</label>
                <select id="editStatus"
                        class="w-full bg-[#0d1117] border border-[#30363d] rounded px-3 py-2 text-sm text-gray-300 focus:border-blue-500 outline-none">
                  ${['NEW','PROCESSING','MITIGATED','CLOSED']
                    .map(s => `<option value="${s}" ${data.status === s ? 'selected': ''}>${s}</option>`).join('')}
                </select>
              </div>

              <div>
                <label class="block text-xs text-gray-500 mb-1">ê´€ë¦¬ì ë©”ëª¨</label>
                <textarea id="editNote" rows="2"
                  class="w-full bg-[#0d1117] border border-[#30363d] rounded px-3 py-2 text-sm text-gray-300 focus:border-blue-500 outline-none">${data.note || ''}</textarea>
              </div>
            </div>

            <div class="mt-4 text-right">
              <button onclick="saveIncident()"
                      class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-xs font-bold transition-colors">
                ì €ì¥í•˜ê¸°
              </button>
            </div>
          </div>
        `;
      }

      /* meta / details JSON í‘œì‹œ */
      if (data.meta || data.details) {
        let raw = data.meta || data.details;
        let pretty = '';

        if (typeof raw === 'string') {
          try { pretty = JSON.stringify(JSON.parse(raw), null, 2); }
          catch { pretty = raw; }
        } else {
          pretty = JSON.stringify(raw, null, 2);
        }

        html += `
          <div class="mt-6 pt-6 border-t border-[#30363d]">
            <h4 class="text-sm font-bold text-gray-400 mb-2">ì¶”ê°€ ë°ì´í„° (JSON / ì„¸ë¶€ ì •ë³´)</h4>
            <pre class="bg-[#0d1117] p-4 rounded-lg text-xs text-gray-400 overflow-x-auto border border-[#30363d]">${pretty}</pre>
          </div>
        `;
      }

      content.innerHTML = html;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    /* ì¸ì‹œë˜íŠ¸ ìƒì„¸ ì €ì¥ */
    async function saveIncident() {
      if (!currentIncidentId) return;

      const newStatus = document.getElementById('editStatus').value;
      const newNote = document.getElementById('editNote').value;

      const inc = state.incidents.find(i => i.incident_id === currentIncidentId);
      if (inc) {
        inc.status = newStatus;
        inc.note = newNote;
        inc.updated_at = Date.now();
      }

      renderTables();
      closeModal();

      try {
        await fetch(INCIDENT_UPDATE_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            incident_id: currentIncidentId,
            status: newStatus,
            note: newNote
          })
        });
      } catch (e) { console.error("saveIncident error:", e); }
    }

    /* UI Helper */
    function getBadgeClass(sev) {
      if (sev === 'CRITICAL') return 'bg-red-900/30 text-red-300 border border-red-800/50';
      if (sev === 'HIGH')     return 'bg-orange-900/30 text-orange-300 border border-orange-800/50';
      if (sev === 'MEDIUM')   return 'bg-yellow-900/30 text-yellow-300 border border-yellow-800/50';
      return 'bg-green-900/30 text-green-300 border border-green-800/50';
    }

    function getRemedClass(st) {
      return st === 'SUCCEEDED'
        ? 'bg-green-900/30 text-green-300 border border-green-800/50'
        : 'bg-gray-800 text-gray-400 border border-gray-700';
    }

    function getNotifyBadgeClass(st) {
      st = (st || 'SENT').toUpperCase();
      if (st === 'FAILED')  return 'bg-red-900/30 text-red-300 border border-red-800/50';
      if (st === 'PENDING') return 'bg-yellow-900/30 text-yellow-300 border border-yellow-800/50';
      return 'bg-blue-900/30 text-blue-300 border border-blue-800/50';
    }

    function formatTime(ts) {
      if (!ts) return '-';
      let d;

      if (typeof ts === 'number')
        d = new Date(ts);
      else {
        const parsed = Date.parse(ts);
        if (!isNaN(parsed)) d = new Date(parsed);
        else return ts;
      }
      if (isNaN(d.getTime())) return ts;

      return `${d.getHours().toString().padStart(2,'0')}:` +
             `${d.getMinutes().toString().padStart(2,'0')}:` +
             `${d.getSeconds().toString().padStart(2,'0')}`;
    }

    /* ì¸ì‹œë˜íŠ¸ ì—…ë°ì´íŠ¸ ë°˜ì˜ */
    function updateIncidentState(inc) {
      let ts = inc.created_at || inc.time;
      if (typeof ts === 'string') ts = Date.parse(ts);
      if (!ts || isNaN(ts)) ts = Date.now();

      let u = inc.updated_at;
      if (typeof u === 'string') u = Date.parse(u);
      if (!u || isNaN(u)) u = ts;

      const item = { ...inc, created_at: ts, updated_at: u };

      const idx = state.incidents.findIndex(i => i.incident_id === item.incident_id);
      if (idx > -1) {
        state.incidents[idx] = { ...state.incidents[idx], ...item };
      } else {
        state.incidents.unshift(item);
        addEventBucket(item.created_at);
      }
    }
    /* ê°œë³„ WebSocket ìƒíƒœ UI ì—…ë°ì´íŠ¸ */
    function setSectionStatus(elementId, ws) {
      const el = document.getElementById(elementId);
      if (!el) return;

      const connected = ws && ws.readyState === WebSocket.OPEN;

      if (connected) {
        el.innerHTML = "â— ì •ìƒ ì—°ê²°ë¨";
        el.className =
          "ml-2 px-2 py-0.5 rounded text-[10px] border border-green-800/50 " +
          "bg-green-900/30 text-green-400 font-normal transition-colors";
      } else {
        el.innerHTML = "â— ì—°ê²° ëŠê¹€";
        el.className =
          "ml-2 px-2 py-0.5 rounded text-[10px] border border-gray-700 " +
          "bg-gray-800 text-gray-500 font-normal transition-colors";
      }

      checkGlobalStatus();
    }

    /* ìƒë‹¨ ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ */
    function checkGlobalStatus() {
      const e = state.ws.events  && state.ws.events.readyState  === WebSocket.OPEN;
      const r = state.ws.remeds  && state.ws.remeds.readyState  === WebSocket.OPEN;
      const h = state.ws.history && state.ws.history.readyState === WebSocket.OPEN;
      const count = [e, r, h].filter(Boolean).length;

      const main = document.getElementById("connectionStatus");

      if (count === 3) {
        main.className =
          "px-3 py-1 rounded-full text-xs font-medium bg-green-900/30 " +
          "border border-green-700 text-green-400 flex items-center gap-1.5 whitespace-nowrap";
        main.innerHTML =
          '<span class="w-2 h-2 rounded-full bg-green-500"></span> ì‹œìŠ¤í…œ ì •ìƒ ê°€ë™';
      } else {
        main.className =
          "px-3 py-1 rounded-full text-xs font-medium bg-gray-800 text-gray-400 " +
          "border border-gray-700 flex items-center gap-1.5 whitespace-nowrap";
        main.innerHTML =
          `<span class="w-2 h-2 rounded-full bg-gray-500"></span> ë¶€ë¶„ ì—°ê²° (${count}/3)`;
      }
    }

    /* ì¸ì¦ íŒŒë¼ë¯¸í„° ìë™ ì¶”ê°€ */
    function addAuthParams(url) {
      try {
        const u = new URL(url);
        u.searchParams.set("clientId", CLIENT_AUTH.clientId);
        u.searchParams.set("account",  CLIENT_AUTH.account);
        return u.toString();
      } catch {
        return url;
      }
    }

    /* Ping íƒ€ì´ë¨¸ (ì¤‘ë³µ ë°©ì§€) */
    let pingTimer = null;
    function startPing(ws) {
      if (pingTimer) clearInterval(pingTimer);
      pingTimer = setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "ping", timestamp: Date.now() }));
        }
      }, 30000);
    }

    /* WebSocket ì—°ê²° í•¨ìˆ˜ */
    function connect() {
      const urls = {
        event: document.getElementById("eventUrl").value,
        remed: document.getElementById("remedUrl").value,
        hist:  document.getElementById("historyUrl").value
      };
      localStorage.setItem("urls", JSON.stringify(urls));

      /* ê¸°ì¡´ ì—°ê²° ë‹«ê¸° */
      Object.values(state.ws).forEach(ws => {
        if (ws && ws.readyState === WebSocket.OPEN) ws.close();
      });

      /* ì „ì²´ ìƒíƒœ: ì—°ê²° ì‹œë„ ì¤‘... */
      const main = document.getElementById("connectionStatus");
      main.innerHTML =
        '<span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span> ì—°ê²° ì‹œë„ ì¤‘...';

      /* -------------------------------------------------------------------
         1) ë³´ì•ˆ ì´ë²¤íŠ¸ WebSocket
         ------------------------------------------------------------------- */
      if (urls.event) {
        const ws = new WebSocket(addAuthParams(urls.event));

        ws.onopen = () => {
          state.ws.events = ws;
          setSectionStatus("status-events", ws);
          startPing(ws);
        };

        ws.onerror = () => setSectionStatus("status-events", ws);
        ws.onclose = () => setSectionStatus("status-events", ws);

        ws.onmessage = e => {
          try {
            const d = JSON.parse(e.data);

            if (d.type === "ping") { ws.send(JSON.stringify({ type: "pong" })); return; }
            if (d.type === "pong" || d.body === "pong") return;

            let t = d.time;
            if (typeof t === "string") t = Date.parse(t);
            if (!t || isNaN(t)) t = Date.now();

            state.events.push({ ...d, time: t });
            addEventBucket(t);

            if (d.incident_id) {
              updateIncidentState({
                incident_id: d.incident_id,
                event_type: d.type,
                resource: d.resource,
                severity: d.severity,
                status: 'NEW',
                created_at: t
              });
            }

            updateCharts();
            renderTables();
          } catch {}
        };

        state.ws.events = ws;
      }

      /* -------------------------------------------------------------------
         2) ìë™ ëŒ€ì‘ WebSocket
         ------------------------------------------------------------------- */
      if (urls.remed) {
        const ws = new WebSocket(addAuthParams(urls.remed));

        ws.onopen = () => {
          state.ws.remeds = ws;
          setSectionStatus("status-remed", ws);
          startPing(ws);
        };

        ws.onerror = () => setSectionStatus("status-remed", ws);
        ws.onclose = () => setSectionStatus("status-remed", ws);

        ws.onmessage = e => {
          try {
            const d = JSON.parse(e.data);

            if (d.type === "ping") { ws.send(JSON.stringify({ type: "pong" })); return; }
            if (d.type === "pong" || d.body === "pong") return;

            addRemedSafe(d);
          } catch {}
        };

        state.ws.remeds = ws;
      }

      /* -------------------------------------------------------------------
         3) íˆìŠ¤í† ë¦¬ WebSocket
         ------------------------------------------------------------------- */
      if (urls.hist) {
        const ws = new WebSocket(addAuthParams(urls.hist));

        ws.onopen = () => {
          state.ws.history = ws;
          setSectionStatus("status-history", ws);
          ws.send(JSON.stringify({ action: "subscribe", limit: 50 }));
          startPing(ws);
        };

        ws.onerror = () => setSectionStatus("status-history", ws);
        ws.onclose = () => setSectionStatus("status-history", ws);

        ws.onmessage = e => {
          try {
            let d = JSON.parse(e.data);

            if (d.type === "ping") { ws.send(JSON.stringify({ type: "pong" })); return; }
            if (d.type === "pong" || d.body === "pong") return;

            /* ì „ì²´ ë¦¬ìŠ¤íŠ¸ ìˆ˜ì‹  */
            if (d.incidents && Array.isArray(d.incidents)) {
              state.incidents = [];
              d.incidents.forEach(i => updateIncidentState(i));
              updateCharts();
              renderTables();
              return;
            }

            /* Remediation */
            if (d.kind === "remediation" || d.action) {
              addRemedSafe({
                time: d.time || Date.now(),
                action: d.action,
                target: d.target,
                status: d.status,
                incident_id: d.incident_id
              });
              return;
            }

            /* ì¸ì‹œë˜íŠ¸ ì—…ë°ì´íŠ¸ */
            if (d.kind === "incident_update" || d.incident_id || d.incident) {
              const inc = d.incident || d;
              if (inc.incident_id) updateIncidentState(inc);
              updateCharts();
              renderTables();
              return;
            }

          } catch (err) { console.error(err); }
        };

        state.ws.history = ws;
      }
    }

    /* ì´ˆê¸° URL ì¬ë¡œë”© */
    const saved = JSON.parse(localStorage.getItem("urls") || "{}");
    if (saved.event) document.getElementById("eventUrl").value = saved.event;
    if (saved.remed) document.getElementById("remedUrl").value = saved.remed;
    if (saved.hist)  document.getElementById("historyUrl").value = saved.hist;

    /* ì¶”ê°€ëœ Mock ë°ì´í„° ìƒì„± í•¨ìˆ˜ */
    function genMock() {
      const types = ['GuardDuty:EC2/PortScan', 'WAF:SQLInjection', 'IAM:RootActivity', 'S3:PublicAccess'];
      const severities = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
      const regions = ['us-east-1', 'ap-northeast-2', 'eu-west-1'];

      const type = types[Math.floor(Math.random() * types.length)];
      const severity = severities[Math.floor(Math.random() * severities.length)];
      const region = regions[Math.floor(Math.random() * regions.length)];
      const id = 'inc-' + Math.random().toString(36).substr(2, 9);
      const time = Date.now();

      // 1. ê°€ì§œ ë³´ì•ˆ ì´ë²¤íŠ¸ ìƒì„±
      const event = {
        time: time,
        source: 'aws.guardduty',
        type: type,
        arn: `arn:aws:ec2:${region}:123456789012:instance/i-${Math.random().toString(36).substr(2, 8)}`,
        severity: severity,
        region: region,
        incident_id: id
      };

      state.events.unshift(event);
      addEventBucket(time);

      // 2. ê°€ì§œ ì¸ì‹œë˜íŠ¸ ìƒì„± (ì´ë²¤íŠ¸ì™€ ì—°ê²°)
      updateIncidentState({
        incident_id: id,
        event_type: type,
        resource: event.arn,
        severity: severity,
        status: 'NEW',
        created_at: time,
        updated_at: time
      });

      // 3. ëœë¤í•˜ê²Œ ìë™ ëŒ€ì‘ ë¡œê·¸ ìƒì„±
      if (Math.random() > 0.5) {
        const action = 'Lambda:IsolateInstance';
        setTimeout(() => {
          addRemedSafe({
            time: Date.now(),
            action: action,
            target: event.arn,
            status: Math.random() > 0.1 ? 'SUCCEEDED' : 'FAILED',
            incident_id: id
          });
        }, 800);
      }

      updateCharts();
      renderTables();
    }

    /* ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ */
    document.getElementById("saveUrls").onclick = connect;
    document.getElementById("historySearch").oninput = renderTables;
    document.getElementById("historySeverityFilter").onchange = renderTables;
    document.getElementById("historyStatusFilter").onchange = renderTables;

    document.querySelectorAll("th.sortable").forEach(th => {
      th.addEventListener("click", () => {
        handleSort(th.dataset.table, th.dataset.key);
      });
    });

    document.getElementById("detailModal").addEventListener("click", e => {
      if (e.target === e.currentTarget) closeModal();
    });

    document.addEventListener("keydown", e => {
      if (e.key === "Escape") {
        const modal = document.getElementById("detailModal");
        if (!modal.classList.contains("hidden")) closeModal();
      }
    });

    /* Mock ë°ì´í„° í† ê¸€ */
    document.getElementById("toggleMock").onclick = () => {
      state.mockOn = !state.mockOn;
      const btn = document.getElementById("toggleMock");

      btn.textContent = `Mock ë°ì´í„°: ${state.mockOn ? "ON" : "OFF"}`;
      btn.className = state.mockOn
        ? "px-3 py-1.5 text-xs font-medium bg-blue-600 text-white border border-blue-500 rounded transition-colors"
        : "px-3 py-1.5 text-xs font-medium bg-gray-800 border border-gray-700 text-gray-300 rounded";

      if (state.mockOn)
        state.timers.mock = setInterval(() => genMock(), 1500);
      else
        clearInterval(state.timers.mock);
    };

    /* ì•± ì‹œì‘ */
    connect();
  </script>
</body>
</html>
