<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AWS ë³´ì•ˆ ê´€ì œ ì„¼í„°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0f1115;
      --bg-card: #161b22;
      --border: #30363d;
      --text-main: #c9d1d9;
      --accent: #58a6ff;
    }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      overflow-x: hidden;
    }

    /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ (ì™„ì „ ìˆ¨ê¹€) */
    body, .overflow-auto, .overflow-y-scroll, .overflow-x-auto {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }
    body::-webkit-scrollbar,
    .overflow-auto::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }

    /* ì‹¬ê°í•œ ì•Œë¦¼ ê¹œë¹¡ì„ íš¨ê³¼ */
    @keyframes flash-critical {
      0% { background-color: rgba(218, 54, 51, 0.4); }
      100% { background-color: transparent; }
    }
    .animate-flash { animation: flash-critical 2s ease-out; }

    .card {
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    /* í…Œì´ë¸” í—¤ë” ì •ë ¬ ì»¤ì„œ ë° ì•„ì´ì½˜ */
    th.sortable { cursor: pointer; user-select: none; transition: background-color 0.2s; }
    th.sortable:hover { background-color: #21262d; }
    th.sortable::after { content: ' â†•'; font-size: 10px; opacity: 0.3; float: right; margin-left: 4px; }
    th.sortable.asc::after { content: ' â–²'; opacity: 1; color: var(--accent); }
    th.sortable.desc::after { content: ' â–¼'; opacity: 1; color: var(--accent); }

    thead th {
      position: sticky;
      top: 0;
      background-color: var(--bg-card);
      z-index: 10;
      box-shadow: 0 1px 0 var(--border);
    }
    tr:hover { background-color: rgba(255,255,255,0.03); cursor: pointer; }

    .collapsible {
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
    }
    .collapsible.open {
      max-height: 300px;
      opacity: 1;
    }
  </style>
</head>
<body class="text-sm">

  <header class="sticky top-0 z-50 border-b border-[#30363d] bg-[#0f1115]/95 backdrop-blur-md">
    <div class="max-w-[1500px] w-full px-2 md:px-3 mx-auto py-3 md:h-16 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">

      <div class="bg-[#0d1117] p-4 border-b border-[#30363d] rounded-md md:border-none md:bg-transparent md:p-0">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 flex items-center justify-center text-blue-500 shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full drop-shadow-[0_0_8px_rgba(59,130,246,0.5)]">
              <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
              <path d="M12 3v2"/>
              <path d="M12 19v2"/>
              <circle cx="12" cy="12" r="3"/>
              <path d="M3.5 10.5 5 12l-1.5 1.5"/>
              <path d="M20.5 10.5 19 12l1.5 1.5"/>
            </svg>
          </div>
          <h1 class="text-lg font-bold tracking-tight text-white whitespace-nowrap">
            AWS ë³´ì•ˆ ê´€ì œ ì„¼í„°
          </h1>
        </div>
      </div>

      <div class="flex items-center justify-end gap-3">
        <span id="connectionStatus"
              class="px-3 py-1 rounded-full text-xs font-medium bg-gray-800 text-gray-400 border border-gray-700 flex items-center gap-1.5 whitespace-nowrap">
          <span class="w-2 h-2 rounded-full bg-gray-500"></span> ì—°ê²° ëŒ€ê¸°
        </span>

        <button id="toggleMock"
                class="px-3 py-1.5 text-xs font-medium bg-gray-800 border border-gray-700 rounded hover:bg-gray-700 transition-colors text-gray-300 whitespace-nowrap">
          Mock ë°ì´í„°: OFF
        </button>

        <button onclick="toggleSettings()"
                class="p-2 rounded-md hover:bg-gray-800 text-gray-400 hover:text-white transition-colors border border-transparent hover:border-gray-700"
                title="ì—°ê²° ì„¤ì • ì—´ê¸°">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
               viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
        </button>
      </div>
    </div>

    <div id="settingsPanel" class="collapsible border-b border-[#30363d] bg-[#0d1117]">
      <div class="max-w-[1500px] w-full px-2 md:px-3 mx-auto py-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-xs text-gray-500 mb-1 font-medium">ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ URL (ë³´ì•ˆ ì´ë²¤íŠ¸)</label>
          <input id="eventUrl" type="text" class="w-full bg-[#010409] border border-[#30363d] rounded px-3 py-2 text-xs focus:border-blue-500 outline-none text-gray-300 transition-colors placeholder-gray-700" placeholder="wss://...">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1 font-medium">ëŒ€ì‘ ìŠ¤íŠ¸ë¦¼ URL (ìë™ ì¡°ì¹˜)</label>
          <input id="remedUrl" type="text" class="w-full bg-[#010409] border border-[#30363d] rounded px-3 py-2 text-xs focus:border-blue-500 outline-none text-gray-300 transition-colors placeholder-gray-700" placeholder="wss://...">
        </div>
        <div class="flex gap-3 items-end">
          <div class="flex-1">
            <label class="block text-xs text-gray-500 mb-1 font-medium">íˆìŠ¤í† ë¦¬ URL (ì´ë ¥ ê´€ë¦¬)</label>
            <input id="historyUrl" type="text" class="w-full bg-[#010409] border border-[#30363d] rounded px-3 py-2 text-xs focus:border-blue-500 outline-none text-gray-300 transition-colors placeholder-gray-700" placeholder="wss://...">
          </div>
          <button id="saveUrls" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded text-xs font-bold h-[34px] transition-colors shadow-lg shadow-blue-900/20 whitespace-nowrap">
            ì €ì¥ ë° ì—°ê²°
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-[1500px] w-full px-2 md:px-3 mx-auto py-6 space-y-6">

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card p-5 border-l-4 border-l-blue-500 relative overflow-hidden group hover:border-blue-400 transition-colors">
        <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1 truncate">ê¸ˆì¼ ì´ ì¸ì‹œë˜íŠ¸</div>
        <div class="flex items-baseline gap-2 z-10">
          <span id="kpiTotal" class="text-3xl font-bold text-white">0</span>
          <span class="text-xs text-gray-500 whitespace-nowrap">ê±´ ë°œìƒ</span>
        </div>
      </div>
      <div class="card p-5 border-l-4 border-l-red-500 relative overflow-hidden group hover:border-red-400 transition-colors">
        <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1 truncate">ì‹¬ê°í•¨ (Critical)</div>
        <div class="flex items-baseline gap-2 z-10">
          <span id="kpiCritical" class="text-3xl font-bold text-white">0</span>
          <span class="text-xs text-red-400 font-bold animate-pulse whitespace-nowrap" id="criticalIndicator" style="display:none">â— ì¡°ì¹˜ í•„ìš”</span>
        </div>
      </div>
      <div class="card p-5 border-l-4 border-l-green-500 relative overflow-hidden group hover:border-green-400 transition-colors">
        <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1 truncate">ìë™ ëŒ€ì‘ ì„±ê³µ</div>
        <div class="flex items-baseline gap-2 z-10">
          <span id="kpiRemed" class="text-3xl font-bold text-white">0</span>
          <span class="text-xs text-green-500 font-medium whitespace-nowrap">ë°©ì–´ ì„±ê³µ</span>
        </div>
      </div>
      <div class="card p-5 border-l-4 border-l-gray-500 relative overflow-hidden">
        <div class="text-gray-500 text-xs font-semibold uppercase tracking-wider mb-1 truncate">ì‹œìŠ¤í…œ ìƒíƒœ</div>
        <div class="flex items-baseline gap-2 z-10">
          <span class="text-xl md:text-2xl font-bold text-green-400 truncate">ì •ìƒ ê°€ë™</span>
        </div>
        <div class="text-xs text-gray-600 mt-1 truncate">ëª¨ë“  ê°ì§€/ëŒ€ì‘ í™œì„±</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-auto md:h-[340px]">
      <div class="card lg:col-span-2 p-5 h-[300px] md:h-full">
        <h2 class="font-bold text-gray-200 mb-4 text-sm flex items-center gap-2">
          ì‹œê°„ëŒ€ë³„ ë°œìƒ ì¶”ì´ (ìµœê·¼ 24ì‹œê°„)
        </h2>
        <div class="flex-1 relative w-full h-full min-h-0">
          <canvas id="trendChart"></canvas>
        </div>
      </div>
      <div class="card p-5 h-[300px] md:h-full">
        <h2 class="font-bold text-gray-200 mb-4 text-sm">ìœ„í—˜ë„ë³„ ë¶„í¬</h2>
        <div class="flex-1 relative w-full h-full min-h-0 flex justify-center">
          <canvas id="severityChart"></canvas>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
      <div class="card flex flex-col"> 
        <div class="px-5 py-3 border-b border-[#30363d] bg-[#161b22] flex justify-between items-center sticky top-0 z-20">
          <h2 class="font-bold text-gray-200 text-sm flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span> ì‹¤ì‹œê°„ ë³´ì•ˆ ì´ë²¤íŠ¸
          </h2>
          <span id="eventsCountBadge" class="bg-gray-800 text-gray-400 px-2 py-0.5 rounded text-xs font-mono">0</span>
        </div>
        <div class="overflow-auto bg-[#0d1117] flex-1 min-h-[150px] max-h-[400px]">
          <table class="w-full text-left border-collapse table-fixed"> 
            <thead class="text-gray-400 text-xs uppercase bg-[#0d1117] sticky top-0 z-10 shadow-sm">
            <tr>
              <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-24 sortable whitespace-nowrap text-center" data-table="events" data-key="time">ì‹œê°„</th>
              <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-24 sortable whitespace-nowrap text-center" data-table="events" data-key="source">ì†ŒìŠ¤</th>
              <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-40 sortable whitespace-nowrap text-center" data-table="events" data-key="type">ì´ë²¤íŠ¸ ìœ í˜•</th>
              <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-auto sortable whitespace-nowrap text-center" data-table="events" data-key="arn">ARN</th>
              <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-24 sortable whitespace-nowrap text-center" data-table="events" data-key="severity">ì‹¬ê°ë„</th>
            </tr>
            </thead>
            <tbody id="eventsBody" class="text-gray-300 text-xs divide-y divide-[#30363d]"></tbody>
          </table>
        </div>
      </div>

      <div class="card flex flex-col"> <div class="px-5 py-3 border-b border-[#30363d] bg-[#161b22] flex justify-between items-center sticky top-0 z-20">
          <h2 class="font-bold text-gray-200 text-sm flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ìë™ ëŒ€ì‘ ë¡œê·¸
          </h2>
          <span id="remedsCountBadge" class="bg-gray-800 text-gray-400 px-2 py-0.5 rounded text-xs font-mono">0</span>
        </div>
        <div class="overflow-auto bg-[#0d1117] flex-1 min-h-[150px] max-h-[400px]">
          <table class="w-full text-left border-collapse table-fixed">
            <thead class="text-gray-400 text-xs uppercase bg-[#0d1117] sticky top-0 z-10 shadow-sm">
              <tr>
                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-24 sortable whitespace-nowrap text-center" data-table="remeds" data-key="time">ì‹œê°„</th>
                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-32 sortable whitespace-nowrap text-center" data-table="remeds" data-key="action">ì¡°ì¹˜ ë‚´ìš©</th>
                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-28 sortable whitespace-nowrap text-center" data-table="remeds" data-key="target">ëŒ€ìƒ</th>
                <th class="px-4 py-3 font-semibold border-b border-[#30363d] w-24 sortable whitespace-nowrap text-center" data-table="remeds" data-key="status">ìƒíƒœ</th>
              </tr>
            </thead>
            <tbody id="remedsBody" class="text-gray-300 text-xs divide-y divide-[#30363d]"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card flex flex-col h-[500px]">
      <div class="px-5 py-3 border-b border-[#30363d] bg-[#161b22] flex flex-col md:flex-row md:justify-between md:items-center gap-3 sticky top-0 z-20">
        <h2 class="font-bold text-gray-200 text-sm">ì¸ì‹œë˜íŠ¸ ì´ë ¥ ê´€ë¦¬ (History)</h2>
        <div class="flex flex-wrap gap-2 w-full md:w-auto">
          <input id="historySearch" type="text" placeholder="ID, ìœ í˜•, ë¦¬ì†ŒìŠ¤ ê²€ìƒ‰..." class="bg-[#0d1117] border border-[#30363d] rounded px-3 py-1.5 text-xs text-gray-300 w-full md:w-64 focus:border-blue-500 outline-none placeholder-gray-600 transition-colors">
          <div class="flex gap-2 w-full md:w-auto">
            <select id="historySeverityFilter" class="bg-[#0d1117] border border-[#30363d] rounded px-3 py-1.5 text-xs text-gray-300 focus:border-blue-500 outline-none transition-colors flex-1 md:flex-none">
              <option value="ALL">ëª¨ë“  ì‹¬ê°ë„</option>
              <option value="CRITICAL">Critical</option>
              <option value="HIGH">High</option>
              <option value="MEDIUM">Medium</option>
              <option value="LOW">Low</option>
            </select>
            <select id="historyStatusFilter" class="bg-[#0d1117] border border-[#30363d] rounded px-3 py-1.5 text-xs text-gray-300 focus:border-blue-500 outline-none transition-colors flex-1 md:flex-none">
              <option value="ALL">ëª¨ë“  ìƒíƒœ</option>
              <option value="NEW">ì‹ ê·œ</option>
              <option value="PROCESSING">ì§„í–‰ì¤‘</option>
              <option value="MITIGATED">ì™„í™”ë¨</option>
              <option value="CLOSED">ì¢…ë£Œ</option>
            </select>
          </div>
        </div>
      </div>
      <div class="overflow-auto bg-[#0d1117] flex-1">
        <table class="w-full text-left border-collapse table-fixed">
          <thead class="text-gray-400 text-xs uppercase bg-[#161b22] sticky top-0 z-10 shadow-sm border-b border-[#30363d]">
            <tr>
              <th class="px-4 py-3 font-semibold w-28 sortable whitespace-nowrap text-center" data-table="incidents" data-key="incident_id">ì¸ì‹œë˜íŠ¸ ID</th>
              <th class="px-4 py-3 font-semibold w-40 sortable whitespace-nowrap text-center" data-table="incidents" data-key="event_type">ì´ë²¤íŠ¸ ìœ í˜•</th>
              <th class="px-4 py-3 font-semibold w-32 sortable whitespace-nowrap text-center" data-table="incidents" data-key="resource">ë¦¬ì†ŒìŠ¤</th>
              <th class="px-4 py-3 font-semibold w-24 sortable whitespace-nowrap text-center" data-table="incidents" data-key="severity">ì‹¬ê°ë„</th>
              <th class="px-4 py-3 font-semibold w-32 sortable whitespace-nowrap text-center" data-table="incidents" data-key="status">ìƒíƒœ</th>
              <th class="px-4 py-3 font-semibold w-24 sortable whitespace-nowrap text-center" data-table="incidents" data-key="notify_status">ì•Œë¦¼ ìƒíƒœ</th>
              <th class="px-4 py-3 font-semibold w-24 whitespace-nowrap text-center">ë©”ëª¨</th>
              <th class="px-4 py-3 font-semibold w-24 sortable whitespace-nowrap text-center" data-table="incidents" data-key="created_at">ë°œìƒ ì‹œê°„</th>
              <th class="px-4 py-3 font-semibold w-24 sortable whitespace-nowrap text-center" data-table="incidents" data-key="created_at">ì¡°ì¹˜ ì‹œê°„</th>
            </tr>
          </thead>
          <tbody id="incidentBody" class="text-gray-300 text-xs divide-y divide-[#30363d]"></tbody>
        </table>
      </div>
    </div>

  </main>

  <div id="detailModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-[100] px-2">
    <div class="bg-[#161b22] border border-[#30363d] rounded-lg shadow-2xl w-full max-w-3xl max-h-[85vh] flex flex-col animate-[fadeIn_0.2s_ease-out]">
      <div class="px-6 py-4 border-b border-[#30363d] flex justify-between items-center bg-[#161b22] rounded-t-lg">
        <h3 class="font-bold text-white text-lg flex items-center gap-2">
          ğŸ” ìƒì„¸ ì •ë³´ ë° ì¡°ì¹˜
        </h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl leading-none transition-colors">&times;</button>
      </div>
      <div id="detailContent" class="p-6 overflow-y-auto text-sm text-gray-300 space-y-6"></div>
    </div>
  </div>

  <script>
    // --- UI Interactions ---
    function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('open'); }
    function closeModal() {
      const modal = document.getElementById('detailModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // --- Constants & State ---
    const INCIDENT_UPDATE_ENDPOINT = "https://uagp4c6jbh.execute-api.us-east-1.amazonaws.com/incident/update";
    const CLIENT_AUTH = { clientId: "dashboard_admin", account: "021417007719", region: "us-east-1" };

    const state = {
      events: [], remeds: [], incidents: [],
      mockOn: false, timers: { mock: null },
      ws: { events: null, remeds: null, history: null },
      buckets: new Map(),
      sort: {
        events: { key: 'time', dir: 'desc' },
        remeds: { key: 'time', dir: 'desc' },
        incidents: { key: 'created_at', dir: 'desc' }
      }
    };
    let currentIncidentId = null;

    // --- Chart Setup ---
    Chart.defaults.color = '#8b949e';
    Chart.defaults.borderColor = '#30363d';
    Chart.defaults.font.family = "'Noto Sans KR', sans-serif";

    const trendChart = new Chart(document.getElementById('trendChart'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'ì´ë²¤íŠ¸ ë°œìƒ',
          data: [],
          borderColor: '#58a6ff',
          backgroundColor: 'rgba(88, 166, 255, 0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true,
          pointRadius: 2,
          pointHoverRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
        scales: {
          x: { grid: { display: false }, ticks: { maxTicksLimit: 12, font: { size: 11 } } },
          y: { beginAtZero: true, grid: { color: '#21262d' }, ticks: { stepSize: 1, font: { size: 11 } } }
        },
        interaction: { intersect: false, mode: 'index' }
      }
    });

    const severityChart = new Chart(document.getElementById('severityChart'), {
      type: 'doughnut',
      data: {
        labels: ['Critical', 'High', 'Medium', 'Low'],
        datasets: [{
          data: [0, 0, 0, 0],
          backgroundColor: ['#da3633', '#d29922', '#db6d28', '#238636'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 }, color: '#c9d1d9' } } }
      }
    });

    // --- Sorting Logic ---
    function handleSort(tableType, key) {
      const current = state.sort[tableType];
      if (current.key === key) {
        current.dir = current.dir === 'asc' ? 'desc' : 'asc';
      } else {
        current.key = key;
        current.dir = 'desc';
      }

      document.querySelectorAll(`th[data-table="${tableType}"]`).forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.key === key) {
          th.classList.add(current.dir);
        }
      });

      renderTables();
    }

    function getSortedData(data, config) {
      const { key, dir } = config;
      const modifier = dir === 'asc' ? 1 : -1;
      const severityOrder = { 'CRITICAL': 4, 'HIGH': 3, 'MEDIUM': 2, 'LOW': 1 };

      return [...data].sort((a, b) => {
        let valA = a[key] || '';
        let valB = b[key] || '';

        if (typeof valA === 'number' && typeof valB === 'number') {
          return (valA - valB) * modifier;
        }
        if (key === 'severity') {
          return ((severityOrder[valA] || 0) - (severityOrder[valB] || 0)) * modifier;
        }
        return String(valA).localeCompare(String(valB)) * modifier;
      });
    }

    // --- Data Processing & Rendering ---
    function updateCharts() {
      const now = Date.now();
      const labels = [], data = [];
      for(let i=23; i>=0; i--) {
        const t = new Date(now - i*60*60*1000);
        t.setMinutes(0,0,0);
        const k = t.getTime();
        labels.push(`${t.getHours().toString().padStart(2,'0')}:00`);
        data.push(state.buckets.get(k) || 0);
      }
      trendChart.data.labels = labels;
      trendChart.data.datasets[0].data = data;
      trendChart.update('none');

      const counts = { CRITICAL:0, HIGH:0, MEDIUM:0, LOW:0 };
      state.incidents.forEach(i => {
        const s = (i.severity || 'LOW').toUpperCase();
        if(counts[s] !== undefined) counts[s]++;
      });
      severityChart.data.datasets[0].data = [counts.CRITICAL, counts.HIGH, counts.MEDIUM, counts.LOW];
      severityChart.update();

      document.getElementById('kpiTotal').textContent = state.incidents.length;
      document.getElementById('kpiCritical').textContent = counts.CRITICAL;
      document.getElementById('kpiRemed').textContent = state.remeds.filter(r => r.status === 'SUCCEEDED').length;

      const critInd = document.getElementById('criticalIndicator');
      critInd.style.display = counts.CRITICAL > 0 ? 'inline' : 'none';
    }

    function addEventBucket(ts) {
      const d = new Date(ts);
      d.setMinutes(0,0,0);
      const k = d.getTime();
      state.buckets.set(k, (state.buckets.get(k)||0) + 1);
    }

    function getNotifyBadgeClass(status) {
      const s = (status || 'SENT').toUpperCase(); // ê¸°ë³¸ê°’ SENT
      if (s === 'FAILED') return 'bg-red-900/30 text-red-300 border border-red-800/50';
      if (s === 'PENDING') return 'bg-yellow-900/30 text-yellow-300 border border-yellow-800/50';
      return 'bg-blue-900/30 text-blue-300 border border-blue-800/50'; // SENT
    }

    function renderTables() {
      // --- 1. ì‹¤ì‹œê°„ ë³´ì•ˆ ì´ë²¤íŠ¸ (Events) ---
      const sortedEvents = getSortedData(state.events, state.sort.events);
      const evBody = document.getElementById('eventsBody');
      
      evBody.innerHTML = sortedEvents.slice(0, 20).map(e => `
        <tr onclick="showDetail(state.events.find(x=>x.time==${e.time}), 'event')" class="transition-colors border-b border-[#30363d]/50 hover:bg-[#161b22] ${e.severity==='CRITICAL'?'animate-flash':''}">
          <td class="px-4 py-3 whitespace-nowrap text-gray-400 font-mono text-xs truncate">
            ${formatTime(e.time)}
          </td>
          <td class="px-4 py-3 text-gray-300 truncate" title="${e.source || '-'}">
              ${e.source || '-'}
          </td>
          <td class="px-4 py-3 text-gray-200 font-medium truncate" title="${e.type}">
            ${e.type}
          </td>
          <td class="px-4 py-3 text-gray-400 truncate" title="${e.arn || e.resource}">
            ${e.arn || e.resource || '-'}
          </td>
          <td class="px-4 py-3 text-center">
            <span class="inline-block px-2 py-0.5 rounded text-[11px] font-bold whitespace-nowrap ${getBadgeClass(e.severity)}">
              ${e.severity}
            </span>
          </td>
        </tr>
      `).join('');
      document.getElementById('eventsCountBadge').textContent = state.events.length;

      // --- 2. ìë™ ëŒ€ì‘ ë¡œê·¸ (Remediations) ---
      const sortedRemeds = getSortedData(state.remeds, state.sort.remeds);
      const remBody = document.getElementById('remedsBody');
      
      remBody.innerHTML = sortedRemeds.slice(0, 20).map(r => `
        <tr onclick="showDetail(state.remeds.find(x=>x.time==${r.time}), 'remed')" class="border-b border-[#30363d]/50 hover:bg-[#161b22]">
          <td class="px-4 py-3 whitespace-nowrap text-gray-400 font-mono text-xs truncate">
            ${formatTime(r.time)}
          </td>
          <td class="px-4 py-3 text-blue-400 font-medium truncate" title="${r.action}">
            ${r.action}
          </td>
          <td class="px-4 py-3 text-gray-400 truncate" title="${r.target}">
            ${r.target}
          </td>
          <td class="px-4 py-3 text-center">
            <span class="inline-block px-2 py-0.5 rounded text-[11px] font-bold whitespace-nowrap ${getRemedClass(r.status)}">
              ${r.status}
            </span>
          </td>
        </tr>
      `).join('');
      document.getElementById('remedsCountBadge').textContent = state.remeds.length;

      // --- 3. ì¸ì‹œë˜íŠ¸ ì´ë ¥ (History) ---
      const search = document.getElementById('historySearch').value.toLowerCase();
      const filterSev = document.getElementById('historySeverityFilter').value;
      const filterStatus = document.getElementById('historyStatusFilter').value;

      let filtered = state.incidents.filter(i => {
        if(filterSev !== 'ALL' && i.severity !== filterSev) return false;
        if(filterStatus !== 'ALL' && i.status !== filterStatus) return false;
        if(search && !JSON.stringify(i).toLowerCase().includes(search)) return false;
        return true;
      });

      filtered = getSortedData(filtered, state.sort.incidents);

      document.getElementById('incidentBody').innerHTML = filtered.slice(0, 50).map(i => {
        const statusColorClass = i.status === 'NEW' ? 'text-blue-400' : 
                                 i.status === 'MITIGATED' ? 'text-green-400' : 
                                 i.status === 'CLOSED' ? 'text-gray-500' : 'text-yellow-400';
        
        // ë°ì´í„°ì— notify_statusê°€ ì—†ìœ¼ë©´ 'SENT'ë¡œ ê°€ì •
        const notifyStatus = i.notify_status || 'SENT'; 

        return `
        <tr onclick="showDetail(state.incidents.find(x=>x.incident_id=='${i.incident_id}'), 'incident')" class="border-b border-[#30363d]/50 hover:bg-[#161b22] cursor-pointer">
          <td class="px-4 py-3 font-mono text-blue-400 text-xs truncate" title="${i.incident_id}">${i.incident_id}</td>
          <td class="px-4 py-3 text-gray-200 font-medium truncate" title="${i.event_type}">${i.event_type}</td>
          <td class="px-4 py-3 text-gray-400 truncate" title="${i.resource}">${i.resource}</td>
          <td class="px-4 py-3 text-center"><span class="inline-block px-2 py-0.5 rounded text-[11px] font-bold ${getBadgeClass(i.severity)}">${i.severity}</span></td>

          <td class="px-4 py-3 text-center" onclick="event.stopPropagation()">
            <select onchange="updateIncidentStatus('${i.incident_id}', this.value)" 
                    class="w-28 bg-transparent border border-gray-700 rounded px-1 py-1 text-xs font-bold outline-none focus:border-blue-500 cursor-pointer ${statusColorClass}">
              <option value="NEW" class="bg-[#161b22] text-blue-400" ${i.status==='NEW'?'selected':''}>NEW</option>
              <option value="PROCESSING" class="bg-[#161b22] text-yellow-400" ${i.status==='PROCESSING'?'selected':''}>PROCESSING</option>
              <option value="MITIGATED" class="bg-[#161b22] text-green-400" ${i.status==='MITIGATED'?'selected':''}>MITIGATED</option>
              <option value="CLOSED" class="bg-[#161b22] text-gray-500" ${i.status==='CLOSED'?'selected':''}>CLOSED</option>
            </select>
          </td>
          <td class="px-4 py-3 text-center">
            <span class="inline-block px-2 py-0.5 rounded text-[10px] text-center font-bold tracking-wider ${getNotifyBadgeClass(notifyStatus)}">
              ${notifyStatus.toUpperCase()}
            </span>
          </td>
          <td class="px-4 py-3 text-gray-500 text-xs truncate" title="${i.note || ''}">${i.note || '-'}</td>
          <td class="px-4 py-3 text-gray-500 whitespace-nowrap font-mono text-xs text-center">${formatTime(i.created_at)}</td>
          <td class="px-5 py-2.5 text-gray-500 whitespace-nowrap font-mono text-xs text-center">${formatTime(i.updated_at)}</td>
        </tr>
      `}).join('');
    }

    async function updateIncidentStatus(id, newStatus) {
      // 1. ìƒíƒœ ê°ì²´ ì°¾ê¸° ë° ë‚™ê´€ì  ì—…ë°ì´íŠ¸ (í™”ë©´ ì¦‰ì‹œ ë°˜ì˜)
      const inc = state.incidents.find(i => i.incident_id === id);
      if(inc) {
        inc.status = newStatus;
        inc.updated_at = Date.now();
      }
      
      renderTables();
      
      console.log(`Updating incident ${id} to ${newStatus}`);
      try {
        const res = await fetch(INCIDENT_UPDATE_ENDPOINT, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ incident_id: id, status: newStatus })
        });
        
        if(res.ok) {
           // ì„±ê³µ ì‹œ ê°„ë‹¨í•œ í”¼ë“œë°± íš¨ê³¼ (ì„ íƒì )
           // alert("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); 
        } else {
           console.error("API ì €ì¥ ì‹¤íŒ¨");
        }
      } catch(e) { 
        console.error("ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬", e); 
      }
    }

    function addRemedSafe(r) {
      if (!r.action || r.action.toLowerCase() === 'ping' || r.action.toLowerCase() === 'pong') return;

      state.remeds.push({ ...r, time: Date.now() });

      if(r.incident_id && r.status === 'SUCCEEDED') {
        const inc = state.incidents.find(i => i.incident_id === r.incident_id);
        if(inc) {
          inc.status = 'MITIGATED';
          inc.updated_at = Date.now();
        }
      }
      updateCharts(); renderTables();
    }

    function showDetail(data, type) {
      if(!data) return;
      const modal = document.getElementById('detailModal');
      const content = document.getElementById('detailContent');

      if(data.incident_id) currentIncidentId = data.incident_id;
      else currentIncidentId = null;

      let html = `<div class="grid grid-cols-[120px_1fr] gap-y-4 text-sm">`;

      const labelMap = {
        time:'ì‹œê°„', source:'ì†ŒìŠ¤', type:'ìœ í˜•', sg:'ë³´ì•ˆê·¸ë£¹', arn:'ARN', resource:'ë¦¬ì†ŒìŠ¤',
        account:'ê³„ì •ID', region:'ë¦¬ì „', severity:'ì‹¬ê°ë„', ip:'IP ì£¼ì†Œ',
        action:'ì¡°ì¹˜ëª…', target:'ëŒ€ìƒ', playbook:'í”Œë ˆì´ë¶', status:'ìƒíƒœ',
        incident_id:'ì¸ì‹œë˜íŠ¸ ID', event_type:'ì´ë²¤íŠ¸ ìœ í˜•', created_at:'ìƒì„±ì¼', updated_at:'ìˆ˜ì •ì¼',
        note:'ê´€ë¦¬ì ë©”ëª¨'
      };

      Object.keys(data).forEach(k => {
        if(['meta', 'details', 'related'].includes(k)) return;
        let val = data[k];
        if(!val && val !== 0) return;

        let displayVal = val;
        if(['time','created_at','updated_at'].includes(k)) displayVal = formatTime(val);
        if(k === 'severity') displayVal = `<span class="${getBadgeClass(val)} px-2 py-0.5 rounded text-xs">${val}</span>`;
        if(k === 'status') displayVal = `<span class="font-bold ${val==='NEW'?'text-blue-400':val==='MITIGATED'?'text-green-400':'text-gray-400'}">${val}</span>`;

        html += `<div class="font-semibold text-gray-500">${labelMap[k] || k}</div>
                 <div class="text-gray-200 break-all">${displayVal}</div>`;
      });
      html += `</div>`;

      if(type === 'incident' || data.incident_id) {
        html += `
          <div class="mt-6 pt-6 border-t border-[#30363d]">
            <h4 class="text-base font-bold text-white mb-4">ğŸ› ï¸ ì¸ì‹œë˜íŠ¸ ê´€ë¦¬</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs text-gray-500 mb-1">ì§„í–‰ ìƒíƒœ ë³€ê²½</label>
                <select id="editStatus" class="w-full bg-[#0d1117] border border-[#30363d] rounded px-3 py-2 text-sm text-gray-300 focus:border-blue-500 outline-none">
                  ${['NEW','PROCESSING','MITIGATED','CLOSED'].map(s => `<option value="${s}" ${data.status===s?'selected':''}>${s}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-1">ê´€ë¦¬ì ë©”ëª¨</label>
                <textarea id="editNote" rows="2" class="w-full bg-[#0d1117] border border-[#30363d] rounded px-3 py-2 text-sm text-gray-300 focus:border-blue-500 outline-none" placeholder="ì¡°ì¹˜ ë‚´ì—­ì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”">${data.note || ''}</textarea>
              </div>
            </div>
            <div class="mt-4 text-right">
              <button onclick="saveIncident()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-xs font-bold transition-colors">
                ì €ì¥í•˜ê¸°
              </button>
            </div>
          </div>
        `;
      }

      if(data.meta || data.details) {
        let metaRaw = data.meta || data.details;
        let pretty = '';
        if (typeof metaRaw === 'string') {
          try {
            const parsed = JSON.parse(metaRaw);
            pretty = JSON.stringify(parsed, null, 2);
          } catch {
            pretty = metaRaw;
          }
        } else {
          pretty = JSON.stringify(metaRaw, null, 2);
        }

        html += `
          <div class="mt-6 pt-6 border-t border-[#30363d]">
            <h4 class="text-sm font-bold text-gray-400 mb-2">ì¶”ê°€ ë°ì´í„° (JSON / ì„¸ë¶€ ì •ë³´)</h4>
            <pre class="bg-[#0d1117] p-4 rounded-lg text-xs text-gray-400 overflow-x-auto border border-[#30363d]">${pretty}</pre>
          </div>
        `;
      }

      content.innerHTML = html;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    async function saveIncident() {
      if(!currentIncidentId) return;
      const newStatus = document.getElementById('editStatus').value;
      const newNote = document.getElementById('editNote').value;

      const inc = state.incidents.find(i => i.incident_id === currentIncidentId);
      if(inc) {
        inc.status = newStatus;
        inc.note = newNote;
        inc.updated_at = Date.now();
      }
      
      renderTables();
      closeModal();

      try {
        await fetch(INCIDENT_UPDATE_ENDPOINT, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ incident_id: currentIncidentId, status: newStatus, note: newNote })
        });
      } catch(e) { console.error("ì €ì¥ ì—ëŸ¬", e); }
    }

    function getBadgeClass(sev) {
      if(sev === 'CRITICAL') return 'bg-red-900/30 text-red-300 border border-red-800/50';
      if(sev === 'HIGH') return 'bg-orange-900/30 text-orange-300 border border-orange-800/50';
      if(sev === 'MEDIUM') return 'bg-yellow-900/30 text-yellow-300 border border-yellow-800/50';
      return 'bg-green-900/30 text-green-300 border border-green-800/50';
    }
    function getRemedClass(st) {
      return st === 'SUCCEEDED'
        ? 'bg-green-900/30 text-green-300 border border-green-800/50'
        : 'bg-gray-800 text-gray-400 border border-gray-700';
    }

    function formatTime(ts) {
      if(!ts) return '-';
      let d;
      if (typeof ts === 'number') {
        d = new Date(ts);
      } else {
        const parsed = Date.parse(ts);
        if (!isNaN(parsed)) d = new Date(parsed);
        else return ts;
      }
      if (isNaN(d.getTime())) return ts;
      return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`;
    }

    function addAuthParams(url) {
      try {
        const u = new URL(url);
        u.searchParams.set('clientId', CLIENT_AUTH.clientId);
        u.searchParams.set('account', CLIENT_AUTH.account);
        return u.toString();
      } catch { return url; }
    }

    function updateIncidentState(inc) {
      let ts = inc.created_at || inc.time;
      if(typeof ts === 'string') ts = Date.parse(ts);
      if(!ts || isNaN(ts)) ts = Date.now();

      let uts = inc.updated_at;
      if(typeof uts === 'string') uts = Date.parse(uts);
      if(!uts || isNaN(uts)) uts = ts;

      const cleanInc = { ...inc, created_at: ts, updated_at: uts };
      
      const idx = state.incidents.findIndex(i => i.incident_id === cleanInc.incident_id);
      
      if (idx > -1) {
        state.incidents[idx] = { ...state.incidents[idx], ...cleanInc };
      } else {
        state.incidents.unshift(cleanInc);
        addEventBucket(cleanInc.created_at);
      }
    }

    function connect() {
      const urls = {
        event: document.getElementById('eventUrl').value,
        remed: document.getElementById('remedUrl').value,
        hist: document.getElementById('historyUrl').value
      };
      localStorage.setItem('urls', JSON.stringify(urls));

      Object.values(state.ws).forEach(ws => ws && ws.close());

      const setStatus = (msg, color) => {
        const el = document.getElementById('connectionStatus');
        if (!el) return;
        el.innerHTML = `<span class="w-2 h-2 rounded-full ${color}"></span> ${msg}`;
        const variant =
          color === 'bg-green-500'
            ? 'bg-green-900/30 border-green-700 text-green-400'
            : 'bg-gray-800 border-gray-700 text-gray-400';
        el.className = `px-3 py-1 rounded-full text-xs font-medium border flex items-center gap-1.5 ${variant} whitespace-nowrap`;
      };

      if(urls.event) {
        const ws = new WebSocket(addAuthParams(urls.event));
        ws.onopen = () => {
            setStatus('ì •ìƒ ì—°ê²°ë¨', 'bg-green-500');
            setInterval(() => {
                if (ws.readyState === 1) {
                    ws.send(JSON.stringify({ type: "ping", timestamp: Date.now() }));
                }
            }, 30000);
        };
        ws.onmessage = e => {
          try {
            const d = JSON.parse(e.data);

            if (d.type === 'ping' || d.type === 'ack') {
                //console.log(`Event WS: Ping ë°›ìŒ -> Pong ë³´ëƒ„`);
                ws.send(JSON.stringify({ type: "pong" }));
                return; 
            }
            if (d.type === 'pong' || d.body === 'pong') {
                //console.log(`Event WS: Pong ë„ì°©`);
                return;
            }

            let eventTime = d.time;
            if(typeof eventTime === 'string') eventTime = Date.parse(eventTime);
            if(!eventTime || isNaN(eventTime)) eventTime = Date.now();

            state.events.push({ ...d, time: eventTime });
            addEventBucket(eventTime);

            if(d.incident_id) {
              updateIncidentState({
                incident_id: d.incident_id,
                event_type: d.type,
                resource: d.resource,
                severity: d.severity,
                status: 'NEW',
                created_at: eventTime
              });
            }
            updateCharts(); renderTables();
          } catch {}
        };
        state.ws.events = ws;
      }

      if(urls.remed) {
        const ws = new WebSocket(addAuthParams(urls.remed));
        ws.onopen = () => {
            setInterval(() => {
                if (ws.readyState === 1) {
                    ws.send(JSON.stringify({ type: "ping", timestamp: Date.now() }));
                }
            }, 30000);
        };
        ws.onmessage = e => {
          try {
            const d = JSON.parse(e.data);

            if (d.type === 'ping' || d.type === 'ack') {
                //console.log(`Remed WS: Ping ë°›ìŒ -> Pong ë³´ëƒ„`);
                ws.send(JSON.stringify({ type: "pong" }));
                return; 
            }
            if (d.type === 'pong' || d.body === 'pong') {
                //console.log(`Remed WS: Pong ë„ì°©`);
                return;
            }

            addRemedSafe(d);
          } catch {}
        };
        state.ws.remeds = ws;
      }

      if(urls.hist) {
        const ws = new WebSocket(addAuthParams(urls.hist));
        ws.onopen = () => {
          ws.send(JSON.stringify({ action: "subscribe", limit: 50 }));
          setInterval(() => {
            if (ws.readyState === 1) {
                ws.send(JSON.stringify({ type: "ping", timestamp: Date.now() }));
            }
          }, 30000);
        };
        ws.onmessage = e => {
          try {
            let d;
            try {
                d = JSON.parse(e.data);
                if (typeof d === 'string' || d.body) {
                    const inner = d.body || d;
                    if (typeof inner === 'string') {
                        try { d = JSON.parse(inner); } catch {}
                    }
                }
            } catch (err) {
                console.warn("JSON íŒŒì‹± ì‹¤íŒ¨:", e.data);
                return;
            }

            if (d.type === 'ping' || d.type === 'ack') {
                //console.log(`History WS: Ping ë°›ìŒ -> Pong ë³´ëƒ„`);
                ws.send(JSON.stringify({ type: "pong" }));
                return; 
            }
            if (d.type === 'pong' || d.body === 'pong') {
                //console.log(`History WS: Pong ë„ì°©`);
                return;
            }

            if(d.incidents && Array.isArray(d.incidents)) {
              state.incidents = []; 
              d.incidents.forEach(i => updateIncidentState(i));
              updateCharts(); renderTables();
            } 
            
            else {
                if (d.kind === 'remediation' || d.action) {
                    console.log("ì¡°ì¹˜ ë¡œê·¸ ìˆ˜ì‹ :", d);
                    addRemedSafe({
                        time: d.time || Date.now(),
                        action: d.action,
                        target: d.target,
                        status: d.status,
                        incident_id: d.incident_id
                    });
                }
                else if (d.kind === 'incident_update' || d.incident_id || d.incident) {
                    const incData = d.incident || d;
                    console.log("ì¸ì‹œë˜íŠ¸ ìˆ˜ì‹ :", incData);
                    if (incData.incident_id) {
                        updateIncidentState(incData);
                    }
                }
                
                updateCharts(); 
                renderTables();
            }
          } catch(err) { console.error(err); }
        };
        state.ws.history = ws;
      }
    }

    function genMock() {
      const sevs = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
      const notifyStats = ['SENT', 'PENDING', 'FAILED'];
      const s = sevs[Math.floor(Math.random() * sevs.length)];
      const n = notifyStats[Math.floor(Math.random() * notifyStats.length)];
      const msg = {
        time: Date.now(),
        type: 'UnauthorizedAccess:EC2/SSH',
        resource: 'i-1234567890',
        severity: s,
        incident_id: 'inc-' + Date.now(),
        source: 'GuardDuty',
        notify_status: n
      };
      state.events.push(msg);
      addEventBucket(Date.now());

      if(s === 'CRITICAL') {
        state.incidents.push({ ...msg, event_type: msg.type, status: 'NEW', created_at: Date.now(), updated_at: Date.now() });
        setTimeout(() => {
          const r = { time: Date.now(), action: 'BlockSG', target: msg.resource, status: 'SUCCEEDED' };
          addRemedSafe(r);
          const inc = state.incidents.find(i => i.incident_id === msg.incident_id);
          if(inc) inc.status = 'MITIGATED';
          updateCharts(); renderTables();
        }, 2000);
      }
      updateCharts(); renderTables();
    }

    const saved = JSON.parse(localStorage.getItem('urls') || '{}');
    if(saved.event) document.getElementById('eventUrl').value = saved.event;
    if(saved.remed) document.getElementById('remedUrl').value = saved.remed;
    if(saved.hist) document.getElementById('historyUrl').value = saved.hist;

    document.getElementById('saveUrls').onclick = connect;
    document.getElementById('toggleMock').onclick = () => {
      state.mockOn = !state.mockOn;
      const btn = document.getElementById('toggleMock');
      btn.textContent = `Mock ë°ì´í„°: ${state.mockOn ? 'ON' : 'OFF'}`;
      btn.className = state.mockOn
        ? "px-3 py-1.5 text-xs font-medium bg-blue-600 text-white border border-blue-500 rounded transition-colors whitespace-nowrap"
        : "px-3 py-1.5 text-xs font-medium bg-gray-800 border border-gray-700 text-gray-300 rounded hover:bg-gray-700 transition-colors whitespace-nowrap";
      if(state.mockOn) state.timers.mock = setInterval(genMock, 1500);
      else clearInterval(state.timers.mock);
    };

    document.getElementById('historySearch').oninput = renderTables;
    document.getElementById('historySeverityFilter').onchange = renderTables;
    document.getElementById('historyStatusFilter').onchange = renderTables;

    document.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        handleSort(th.dataset.table, th.dataset.key);
      });
    });

    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('detailModal');
        if (!modal.classList.contains('hidden')) {
          closeModal();
        }
      }
    });

    connect();
  </script>
</body>
</html>
